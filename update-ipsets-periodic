#!/bin/bash

# check if FIREHOL_BLACKLIST exists. Otherwise setup all chains
"${IPTABLES_CMD}" -n --list FIREHOL_BLACKLIST >/dev/null 2>&1
if [ $? == 1 ]; then
  "${IPTABLES_CMD}" -N FIREHOL_BLACKLIST
  "${IPTABLES_CMD}" -A INPUT -j FIREHOL_BLACKLIST
  "${IPTABLES_CMD}" -A DOCKER-USER -j FIREHOL_BLACKLIST
fi

# auto-enable lists defined in env
INIT_LIST_FLAG_FILE="/etc/firehol/lists_init.done"
if [ ! -f "${INIT_LIST_FLAG_FILE}" ]; then
  echo "First Startup: Enabling initial lists defined by env variable FIREHOL_LISTS_INIT: ${FIREHOL_LISTS_INIT}"
  for p in ${FIREHOL_LISTS_INIT}; do
    /bin/enable "${p}"
  done
  touch /etc/firehol/lists_init.done
else
  echo "Initial lists not enabling because this isn't the first start. Not modifying current list configuration" 
fi

for i in $(find /etc/firehol/ipsets -maxdepth 1 -name "*.enabled");
do
    i="${i##*/}"
    i="${i%.*}"
    ipset-apply $i
    if [[ -z $("${IPTABLES_CMD}" -L FIREHOL_BLACKLIST | grep "match-set $i src") ]];
    then
        "${IPTABLES_CMD}" -I FIREHOL_BLACKLIST -m set --match-set $i src -j DROP
    fi
done

# we set up all chains and create ipset lists. So now we only have to update those ipset lists
while :
do
    update-ipsets -s
    sleep $((($RANDOM % 20 + 50) * 10)) # sleeps for about 10 minutes (add random variable to avoid DDoS to iplist provider)
done
