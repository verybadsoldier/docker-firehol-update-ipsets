#!/bin/bash

# =============================================================================
# MINION FIREWALL SETUP - FINAL DUAL STACK VERSION (IPv4 + IPv6)
# Logic: Stateful Inspection + TCP-SYN Geo Whitelist + FireHOL Blacklists
# =============================================================================

readonly FIREHOL_CHAIN=FIREHOL_BLACKLIST

# --- CONFIGURATION & COMMANDS ---
IPTABLES_CMD=${IPTABLES_CMD:-iptables}
IP6TABLES_CMD=${IP6TABLES_CMD:-ip6tables}

readonly CHAIN_TRUSTED="TRUSTED_BYPASS"
readonly IPSET_WHITELIST="geo_whitelist"
readonly IPSET_WHITELIST_V6="geo_whitelist_v6"
readonly COUNTRY_UPDATE_SCRIPT="/bin/update-countries.sh"

# --- GEO WHITELIST CONFIGURATION ---
# Logic:
# 1. Countries must be defined via GEO_WHITELIST_COUNTRIES.
# 2. FEATURE TOGGLE (GEO_WHITELIST_ENABLED) must be "true" or unset (defaults to true).

if [ -n "${GEO_WHITELIST_COUNTRIES}" ] && [ "${GEO_WHITELIST_ENABLED:-true}" == "true" ]; then
    echo "CONFIGURATION: Countries detected (${GEO_WHITELIST_COUNTRIES}) and Geo Whitelist ENABLED."
    GEO_ENABLED="true"
else
    if [ -z "${GEO_WHITELIST_COUNTRIES}" ]; then
        echo "CONFIGURATION: No countries defined. Geo Whitelist is DISABLED."
    else
        echo "CONFIGURATION: Countries defined but Geo Whitelist explicitly DISABLED via GEO_WHITELIST_ENABLED=false."
    fi
    GEO_ENABLED="false"
fi

# =============================================================================
# GENERIC FUNCTION: Setup Firewall Logic (Applies to both v4 and v6)
# =============================================================================
setup_firewall() {
    local cmd=$1          # iptables command
    local geo_set=$2      # ipset name
    local protocol=$3     # ipv4 or ipv6

    echo "--- Setting up $protocol Firewall ($cmd) ---"

    # 1. Initialize & Flush Chain
    "$cmd" -N "${FIREHOL_CHAIN}" >/dev/null 2>&1 || true
    "$cmd" -F "${FIREHOL_CHAIN}"

    # 2. Hook into INPUT and DOCKER-USER
    for chain in INPUT DOCKER-USER; do
        if "$cmd" -L "${chain}" -n >/dev/null 2>&1; then
            "$cmd" -D "${chain}" -j "${FIREHOL_CHAIN}" >/dev/null 2>&1 || true
            "$cmd" -I "${chain}" -j "${FIREHOL_CHAIN}"
        else
            echo "  [!] Info: Chain $chain not found in $cmd. Skipping hook."
        fi
    done

    # 3. GLOBAL STATE BYPASS (Performance)
    "$cmd" -A "${FIREHOL_CHAIN}" -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

    # 4. ALLOW ICMP
    if [ "$protocol" == "ipv6" ]; then
        "$cmd" -A "${FIREHOL_CHAIN}" -p ipv6-icmp -j ACCEPT
    else
        "$cmd" -A "${FIREHOL_CHAIN}" -p icmp -j ACCEPT
    fi

    # 5. TRUSTED BYPASS (Chain Init)
    local chain_trusted="${CHAIN_TRUSTED}"
    "$cmd" -N "${chain_trusted}" >/dev/null 2>&1 || true
    "$cmd" -F "${chain_trusted}"

    # 5a. Add Private/Local Ranges to Trusted
    echo "  [+] Adding Local/Private Networks to Trusted..."
    if [ "$protocol" == "ipv4" ]; then
        # Critical for FHEM/Localhost communication
        "$cmd" -A "${chain_trusted}" -s 127.0.0.0/8 -j ACCEPT
        "$cmd" -A "${chain_trusted}" -s 10.0.0.0/8 -j ACCEPT
        "$cmd" -A "${chain_trusted}" -s 172.16.0.0/12 -j ACCEPT
        "$cmd" -A "${chain_trusted}" -s 192.168.0.0/16 -j ACCEPT
    else
        # IPv6 Local Ranges
        "$cmd" -A "${chain_trusted}" -s ::1/128 -j ACCEPT
        "$cmd" -A "${chain_trusted}" -s fe80::/10 -j ACCEPT
        "$cmd" -A "${chain_trusted}" -s fc00::/7 -j ACCEPT
    fi

    # 5b. Add User Whitelist
    if [ ! -z "${WHITELIST_IPS}" ]; then
        for ip in ${WHITELIST_IPS}; do
             # Simple heuristic: dots for v4, colons for v6
             if [[ "$protocol" == "ipv4" && "$ip" == *"."* ]]; then
                 "$cmd" -A "${chain_trusted}" -s "$ip" -j ACCEPT -m comment --comment "Manual Whitelist IPv4"
             elif [[ "$protocol" == "ipv6" && "$ip" == *":"* ]]; then
                 "$cmd" -A "${chain_trusted}" -s "$ip" -j ACCEPT -m comment --comment "Manual Whitelist IPv6"
             fi
        done
    fi
    "$cmd" -A "${chain_trusted}" -j RETURN

    # Insert Trusted Check
    "$cmd" -A "${FIREHOL_CHAIN}" -j "${chain_trusted}"

    # 6. GEO WHITELIST (TCP SYN ONLY)
    if [ "$GEO_ENABLED" == "true" ]; then
        if ipset list -n | grep -q "^${geo_set}$"; then
            echo "  [+] Active Geo-Whitelist for $protocol"
            "$cmd" -A "${FIREHOL_CHAIN}" -p tcp --syn -m set ! --match-set "${geo_set}" src -j DROP -m comment --comment "Geo-Whitelist TCP"
            # Optional: UDP Port 443 Block (QUIC)
            "$cmd" -A "${FIREHOL_CHAIN}" -p udp --dport 443 -m set ! --match-set "${geo_set}" src -j DROP -m comment --comment "Geo-Whitelist QUIC"
        else
            echo "  [!] Warning: IPSet $geo_set missing. Skipping rule."
        fi
    fi

    # 7. BLACKLISTS (IPv4 only)
    if [ "$protocol" == "ipv4" ]; then
        for i in $(find /etc/firehol/ipsets -maxdepth 1 -name "*.enabled"); do
            i="${i##*/}" # Basename
            i="${i%.*}" # Remove extension
            if [[ -z $("$cmd" -S "${FIREHOL_CHAIN}" | grep "match-set $i src") ]]; then
                "$cmd" -A "${FIREHOL_CHAIN}" -m set --match-set $i src -j DROP -m comment --comment "FireHOL: $i"
            fi
        done
    fi
}


# =============================================================================
# MAIN EXECUTION
# =============================================================================

# 1. Initialize Lists
INIT_LIST_FLAG_FILE="/etc/firehol/lists_init.done"
if [ ! -f "${INIT_LIST_FLAG_FILE}" ]; then
  echo "First Startup: Enabling initial lists..."
  for p in ${FIREHOL_LISTS_INIT}; do
    echo "Enabling: ${p}..."
    /bin/enable "${p}" 2>/dev/null || true
  done
  touch /etc/firehol/lists_init.done
  echo "Finished enabling lists"
fi

echo "----------------------------------------------------------------"

# 2. Update Geo Data
if [ "$GEO_ENABLED" == "true" ] && [ -f "$COUNTRY_UPDATE_SCRIPT" ]; then
    echo "Initializing Geo Whitelist..."
    GEO_IPSET_NAME="$IPSET_WHITELIST" bash "$COUNTRY_UPDATE_SCRIPT"
fi

# 3. Apply Firewall Rules
setup_firewall "${IPTABLES_CMD}" "${IPSET_WHITELIST}" "ipv4"

# Setup IPv6 (Only if command exists)
if command -v "${IP6TABLES_CMD}" >/dev/null; then
    setup_firewall "${IP6TABLES_CMD}" "${IPSET_WHITELIST_V6}" "ipv6"
else
    echo "WARNING: $IP6TABLES_CMD not found. IPv6 remains unprotected!"
fi


# =============================================================================
# MAINTENANCE LOOP
# =============================================================================
echo "Dual-Stack Firewall setup complete. Entering maintenance loop."

LOOP_COUNT=0
while :
do
    echo "Updating FireHOL lists..."
    update-ipsets -s

    if [ "$GEO_ENABLED" == "true" ] && [ $((LOOP_COUNT % 6)) -eq 0 ]; then
        echo "Updating Geo Whitelist..."
        GEO_IPSET_NAME="$IPSET_WHITELIST" GEO_SCOPE_COUNTRIES="${GEO_WHITELIST_COUNTRIES}" bash "$COUNTRY_UPDATE_SCRIPT"
    fi
    ((LOOP_COUNT++))

    sleep $((($RANDOM % 20 + 50) * 10)) 
done