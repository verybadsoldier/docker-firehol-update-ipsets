#!/bin/bash

# better to update the update-ipsets script to the newest version (IP list providers are updated daily basis)
curl -L https://raw.githubusercontent.com/firehol/firehol/master/sbin/update-ipsets -o /sbin/update-ipsets && chmod a+x /sbin/update-ipsets

# restore the latest ipsets
if [ -e /etc/firehol/ipsets/ipset-names.latest ];
then
    ipset restore < /etc/firehol/ipsets/ipset-names.latest
fi

iptables -n --list FIREHOL_WHITELIST_MANUAL >/dev/null 2>&1
if [ $? == 1 ]; then
  echo creating table FIREHOL_WHITELIST_MANUAL ...
  iptables -N FIREHOL_WHITELIST_MANUAL
fi

# update WHITELIST
iptables -F FIREHOL_WHITELIST_MANUAL
if [ ! -z "${WHITELIST_IPS}" ];
then
    echo Adding manual IPs to FIREHOL_WHITELIST_MANUAL
    iptables -A FIREHOL_WHITELIST_MANUAL -s "${WHITELIST_IPS}" -j ACCEPT
fi

iptables -n --list FIREHOL_BLACKLIST >/dev/null 2>&1
if [ $? == 1 ]; then
  iptables -N FIREHOL_BLACKLIST

  iptables -I INPUT -j FIREHOL_BLACKLIST
  iptables -I DOCKER-USER -j FIREHOL_BLACKLIST
fi

# add whitelist rule (delete first as it might exist already)
iptables -D FIREHOL_BLACKLIST -j FIREHOL_WHITELIST_MANUAL
iptables -I FIREHOL_BLACKLIST -j FIREHOL_WHITELIST_MANUAL

for i in $(find /etc/firehol/ipsets -maxdepth 1 -name "*.enabled");
do
    i="${i##*/}"
    i="${i%.*}"
    ipset-apply $i
    if [[ -z $(iptables -L FIREHOL_BLACKLIST | grep "match-set $i src") ]];
    then
        iptables -I FIREHOL_BLACKLIST -m set --match-set $i src -j DROP
    fi
done

while :
do
    update-ipsets -s
    sleep $((($RANDOM % 20 + 50) * 10)) # sleeps for about 10 minutes (add random variable to avoid DDoS to iplist provider)
done
